name: GNOME Shell Compatibility Check

on:
  push:
    branches: [main, master, add-gnome-compatibility-ci]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  compatibility-check:
    name: Test GNOME ${{ matrix.gnome-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - gnome-version: '48'
            fedora-version: '42'
          - gnome-version: '49'
            fedora-version: '43'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build GNOME Shell container
        run: |
          docker build \
            --build-arg fedora_version=${{ matrix.fedora-version }} \
            -t gnome-shell-test:${{ matrix.gnome-version }} \
            .

      - name: Start container with systemd
        run: |
          docker run -d \
            --name gnome-test-${{ matrix.gnome-version }} \
            --privileged \
            --cgroupns=host \
            -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
            -v ${{ github.workspace }}:/workspace:rw \
            gnome-shell-test:${{ matrix.gnome-version }}

          # Wait for systemd to initialize
          sleep 10

      - name: Check container and X server status
        run: |
          docker exec gnome-test-${{ matrix.gnome-version }} systemctl status xvfb@:99.service

      - name: Install pnpm in container
        run: |
          docker exec gnome-test-${{ matrix.gnome-version }} npm install -g pnpm@latest

      - name: Install dependencies
        run: |
          docker exec -w /workspace gnome-test-${{ matrix.gnome-version }} pnpm install --ignore-scripts

      - name: Validate metadata for GNOME ${{ matrix.gnome-version }}
        run: |
          docker exec -w /workspace gnome-test-${{ matrix.gnome-version }} bash -c "
            SHELL_VERSION=\$(jq -r '.\"shell-version\"[]' src/metadata.json | grep '^${{ matrix.gnome-version }}$' || echo '')
            if [ -z \"\$SHELL_VERSION\" ]; then
              echo '❌ GNOME Shell ${{ matrix.gnome-version }} is not listed in metadata.json'
              exit 1
            else
              echo '✅ GNOME Shell ${{ matrix.gnome-version }} is supported in metadata.json'
            fi
          "

      - name: Build extension
        run: |
          docker exec -w /workspace gnome-test-${{ matrix.gnome-version }} pnpm run build

      - name: Validate GSettings schema
        run: |
          docker exec -w /workspace gnome-test-${{ matrix.gnome-version }} glib-compile-schemas --strict --dry-run assets/

      - name: Check extension structure
        run: |
          docker exec -w /workspace gnome-test-${{ matrix.gnome-version }} bash -c "
            if [ ! -f 'dist/builds/mediacontrols@cliffniff.github.com.shell-extension.zip' ]; then
              echo '❌ Extension package not found'
              exit 1
            fi

            echo '✅ Extension package created successfully'
            unzip -l dist/builds/mediacontrols@cliffniff.github.com.shell-extension.zip
            unzip -t dist/builds/mediacontrols@cliffniff.github.com.shell-extension.zip
            echo '✅ Extension package is valid'
          "

      - name: Validate JavaScript syntax
        run: |
          docker exec -w /workspace gnome-test-${{ matrix.gnome-version }} bash -c "
            find dist/temp -name '*.js' -type f -exec node --check {} \;
            echo '✅ All JavaScript files have valid syntax'
          "

      - name: Check GNOME Shell version
        run: |
          docker exec gnome-test-${{ matrix.gnome-version }} bash -c "
            INSTALLED_VERSION=\$(gnome-shell --version | grep -oP '\d+\.\d+' | cut -d. -f1)
            echo \"Installed GNOME Shell version: \$INSTALLED_VERSION\"
            echo \"Expected GNOME Shell version: ${{ matrix.gnome-version }}\"
          "

      - name: Setup D-Bus and start GNOME Shell
        run: |
          docker exec gnome-test-${{ matrix.gnome-version }} bash -c "
            # Start system D-Bus
            systemctl start dbus
            sleep 2
          "

      - name: Start GNOME Shell and test extension
        run: |
          docker exec --user gnomeshell -w /workspace gnome-test-${{ matrix.gnome-version }} bash -c "
            export DISPLAY=:99
            export DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/\$(id -u)/bus

            # Wait for X server
            timeout 30 bash -c 'until xdpyinfo >/dev/null 2>&1; do sleep 1; done'
            echo '✅ X server is ready'

            # Create user runtime directory
            mkdir -p /run/user/\$(id -u)

            # Start user D-Bus session
            dbus-daemon --session --address=\$DBUS_SESSION_BUS_ADDRESS --nofork --nopidfile --syslog-only &
            DBUS_PID=\$!
            sleep 2

            echo '✅ D-Bus session started'

            # Start GNOME Shell in background
            gnome-shell --x11 --wayland=false > /tmp/gnome-shell.log 2>&1 &
            SHELL_PID=\$!
            sleep 15

            # Check if GNOME Shell started
            if ! kill -0 \$SHELL_PID 2>/dev/null; then
              echo '❌ GNOME Shell failed to start'
              cat /tmp/gnome-shell.log || true
              exit 1
            fi

            echo '✅ GNOME Shell started'

            # Install extension
            echo 'Installing extension...'
            gnome-extensions install --force ./dist/builds/mediacontrols@cliffniff.github.com.shell-extension.zip

            # Enable extension
            echo 'Enabling extension...'
            gnome-extensions enable mediacontrols@cliffniff.github.com || echo '⚠️ Could not enable extension'

            # Wait for extension to load
            sleep 5

            # List extensions
            echo 'Installed extensions:'
            gnome-extensions list

            # Get extension info
            echo 'Extension info:'
            gnome-extensions info mediacontrols@cliffniff.github.com || echo 'Extension info not available'

            # Check if GNOME Shell is still running
            if kill -0 \$SHELL_PID 2>/dev/null; then
              echo '✅ GNOME Shell is running'
            else
              echo '⚠️ GNOME Shell process ended'
              cat /tmp/gnome-shell.log || true
            fi

            # Keep processes alive for log collection
            sleep 5
          " || echo "⚠️ Extension runtime test completed with warnings"

      - name: Check for known compatibility issues
        run: |
          docker exec gnome-test-${{ matrix.gnome-version }} bash -c "
            echo '=========================================='
            echo 'Checking for runtime errors in GNOME ${{ matrix.gnome-version }}...'
            echo '=========================================='

            # Check GNOME Shell logs specifically
            echo 'Checking GNOME Shell logs...'
            SHELL_LOGS=\$(journalctl -o cat /usr/bin/gnome-shell --since '5 minutes ago' --no-pager 2>/dev/null || true)

            if [ -n \"\$SHELL_LOGS\" ]; then
              echo '=== GNOME Shell Journal Logs ==='
              echo \"\$SHELL_LOGS\"
              echo ''

              # Check for Media Controls extension errors
              EXTENSION_ERRORS=\$(echo \"\$SHELL_LOGS\" | grep -E '\[Media Controls\].*Error:' || true)

              if [ -n \"\$EXTENSION_ERRORS\" ]; then
                echo '❌ Found errors in Media Controls extension:'
                echo \"\$EXTENSION_ERRORS\"
                echo ''

                # Check for specific error patterns
                if echo \"\$EXTENSION_ERRORS\" | grep -q 'ClickGesture.*not a constructor'; then
                  echo '❌ CRITICAL: ClickGesture compatibility issue detected'
                  echo 'This error occurs because Clutter.ClickGesture is not available in GNOME ${{ matrix.gnome-version }}'
                  exit 1
                fi

                if echo \"\$EXTENSION_ERRORS\" | grep -q 'TypeError\|ReferenceError\|SyntaxError'; then
                  echo '❌ CRITICAL: JavaScript runtime error detected'
                  exit 1
                fi

                # Non-critical errors, just warn
                echo '⚠️ Extension has errors but continuing...'
              else
                echo '✅ No extension errors found in GNOME Shell logs'
              fi
            else
              echo '⚠️ No GNOME Shell logs available yet'
            fi

            # Additional check for GNOME 48 specific issues
            if [ '${{ matrix.gnome-version }}' = '48' ]; then
              echo ''
              echo 'Checking for GNOME 48 specific compatibility issues...'
              if echo \"\$SHELL_LOGS\" | grep -q 'ClickGesture'; then
                echo '❌ Found ClickGesture usage in GNOME 48 (not supported)'
                exit 1
              else
                echo '✅ No GNOME 48 specific issues found'
              fi
            fi

            echo ''
            echo '✅ Runtime compatibility check completed'
          "

      - name: Check for errors in logs
        if: always()
        run: |
          echo '=== Xvfb Service Log ==='
          docker exec gnome-test-${{ matrix.gnome-version }} journalctl -u xvfb@:99.service --no-pager || true

          echo ''
          echo '=== Recent System Logs ==='
          docker exec gnome-test-${{ matrix.gnome-version }} journalctl --since '10 minutes ago' --no-pager | tail -100 || true

          echo ''
          docker exec --user gnomeshell gnome-test-${{ matrix.gnome-version }} bash -c "
            if [ -f /tmp/gnome-shell.log ]; then
              echo '=== GNOME Shell Log ==='
              cat /tmp/gnome-shell.log
            fi
            if [ -f ~/.xsession-errors ]; then
              echo '=== X Session Errors ==='
              cat ~/.xsession-errors
            fi
          " || true

      - name: Summary
        if: success()
        run: |
          echo "✅ Extension is compatible with GNOME Shell ${{ matrix.gnome-version }}"
          echo "- Metadata validation: passed"
          echo "- Build process: passed"
          echo "- GSettings schema: passed"
          echo "- Extension structure: passed"
          echo "- JavaScript syntax: passed"
          echo "- Compatibility check: passed"
          echo "- Runtime test: passed"

      - name: Stop container
        if: always()
        run: |
          docker stop gnome-test-${{ matrix.gnome-version }} || true
          docker rm gnome-test-${{ matrix.gnome-version }} || true

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: extension-build-gnome-${{ matrix.gnome-version }}
          path: dist/builds/*.zip
          if-no-files-found: warn
